# AWS Console SSO Login with IAM Identity Provider

This guide explains how to configure this OIDC provider for AWS Console login via IAM Identity Provider federation, enabling Single Sign-On (SSO) to AWS accounts.

## Overview

With this configuration, users can:
1. Log in through the custom OIDC login page
2. Select which AWS account/application to access from the landing page
3. Be automatically redirected to the AWS Console with the appropriate IAM role

## Prerequisites

- Deployed OIDC provider infrastructure (see README.md)
- AWS account with IAM administrative permissions
- OIDC provider issuer URL (from Terraform outputs)

## Step 1: Register the OIDC Provider in AWS IAM

### 1.1 Get OIDC Provider Information

First, get your OIDC provider's issuer URL and thumbprint:

```bash
# Get the issuer URL
terraform output oidc_issuer_url

# Example output: https://abc123.execute-api.us-east-1.amazonaws.com/dev
```

### 1.2 Create IAM Identity Provider

#### Using AWS Console:

1. Go to **IAM** â†’ **Identity providers** â†’ **Add provider**
2. Choose **OpenID Connect**
3. Fill in the details:
   - **Provider URL**: Your OIDC issuer URL (e.g., `https://abc123.execute-api.us-east-1.amazonaws.com/dev`)
   - **Audience**: The client ID of your application (e.g., `aws-console` or `test-client`)
4. Click **Get thumbprint** (AWS will automatically fetch it)
5. Click **Add provider**

#### Using AWS CLI:

```bash
# Set variables
ISSUER_URL="https://abc123.execute-api.us-east-1.amazonaws.com/dev"
CLIENT_ID="aws-console"

# Create the identity provider
aws iam create-open-id-connect-provider \
  --url "$ISSUER_URL" \
  --client-id-list "$CLIENT_ID" \
  --thumbprint-list "00000000000000000000000000000000000000000"
```

**Note**: The thumbprint can be automatically generated by AWS. For API Gateway endpoints, you may need to get the actual thumbprint:

```bash
# Get thumbprint for API Gateway endpoint
echo | openssl s_client -servername $(echo $ISSUER_URL | sed 's|https://||' | sed 's|/.*||') \
  -connect $(echo $ISSUER_URL | sed 's|https://||' | sed 's|/.*||'):443 2>/dev/null | \
  openssl x509 -fingerprint -noout | sed 's/://g' | sed 's/.*=//' | tr 'A-F' 'a-f'
```

## Step 2: Create IAM Role for OIDC Federation

### 2.1 Create Trust Policy

Create a trust policy document that allows the OIDC provider to assume the role:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/abc123.execute-api.us-east-1.amazonaws.com/dev"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "abc123.execute-api.us-east-1.amazonaws.com/dev:aud": "aws-console",
          "abc123.execute-api.us-east-1.amazonaws.com/dev:sub": "user-*"
        }
      }
    }
  ]
}
```

**Important**: 
- Replace `ACCOUNT_ID` with your AWS account ID
- Replace the OIDC provider URL with your actual issuer URL
- The `aud` field should match your client ID
- The `sub` condition filters which users can assume the role (use `user-*` for all users or specific user IDs)

### 2.2 Create the IAM Role

#### Using AWS Console:

1. Go to **IAM** â†’ **Roles** â†’ **Create role**
2. Select **Web identity**
3. Choose your OIDC provider from the dropdown
4. Enter the **Audience** (client ID, e.g., `aws-console`)
5. Click **Next**
6. Attach permissions policies (e.g., `ReadOnlyAccess`, `PowerUserAccess`, or custom policies)
7. Name the role (e.g., `OIDCConsoleReadOnly`)
8. Click **Create role**

#### Using AWS CLI:

```bash
# Save trust policy to file
cat > trust-policy.json << 'EOF'
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::123456789012:oidc-provider/abc123.execute-api.us-east-1.amazonaws.com/dev"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "abc123.execute-api.us-east-1.amazonaws.com/dev:aud": "aws-console"
        }
      }
    }
  ]
}
EOF

# Create the role
aws iam create-role \
  --role-name OIDCConsoleReadOnly \
  --assume-role-policy-document file://trust-policy.json \
  --description "Read-only console access via OIDC"

# Attach permission policy
aws iam attach-role-policy \
  --role-name OIDCConsoleReadOnly \
  --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
```

### 2.3 Get Role ARN

Save the Role ARN for later use:

```bash
aws iam get-role --role-name OIDCConsoleReadOnly --query 'Role.Arn' --output text
# Output: arn:aws:iam::123456789012:role/OIDCConsoleReadOnly
```

## Step 3: Register the AWS Console as an Application

### 3.1 Register OAuth Client

First, register an OAuth client for AWS Console access:

```bash
# Set variables
REGION="us-east-1"
ENV="dev"
TABLE_NAME="oidc-provider-${ENV}-clients"

# Create AWS Console client
aws dynamodb put-item \
  --table-name "$TABLE_NAME" \
  --item '{
    "client_id": {"S": "aws-console"},
    "client_secret": {"S": "'"$(openssl rand -base64 32)"'"},
    "redirect_uris": {"L": [
      {"S": "https://signin.aws.amazon.com/federation"}
    ]},
    "grant_types": {"L": [
      {"S": "authorization_code"},
      {"S": "refresh_token"}
    ]},
    "response_types": {"L": [{"S": "code"}]},
    "scope": {"S": "openid profile email"}
  }'
```

### 3.2 Register Application in Applications Table

```bash
TABLE_NAME="oidc-provider-${ENV}-applications"

# Create AWS Console application entry
aws dynamodb put-item \
  --table-name "$TABLE_NAME" \
  --item '{
    "application_id": {"S": "aws-console-prod"},
    "name": {"S": "AWS Console (Production)"},
    "description": {"S": "Production AWS account console access"},
    "icon": {"S": "â˜ï¸"},
    "enabled": {"BOOL": true},
    "client_id": {"S": "aws-console"},
    "redirect_url": {"S": "https://signin.aws.amazon.com/federation"},
    "role_arn": {"S": "arn:aws:iam::123456789012:role/OIDCConsoleReadOnly"},
    "account_id": {"S": "123456789012"},
    "account_name": {"S": "Production"}
  }'
```

**Important Fields**:
- `application_id`: Unique identifier for this application
- `name`: Display name shown in the landing page
- `description`: Description shown to users
- `icon`: Emoji or icon to display
- `role_arn`: The IAM role ARN created in Step 2
- `account_id`: AWS account ID
- `account_name`: Friendly name for the account

### 3.3 Grant User Access to Application

```bash
TABLE_NAME="oidc-provider-${ENV}-user-applications"
USER_ID="user-123"  # Get from users table

# Grant user access
aws dynamodb put-item \
  --table-name "$TABLE_NAME" \
  --item '{
    "user_id": {"S": "'"$USER_ID"'"},
    "application_id": {"S": "aws-console-prod"},
    "accounts": {"L": [{"S": "Production"}]},
    "created_at": {"S": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}
  }'
```

## Step 4: Configure Console Sign-In URL Builder

To redirect users to the AWS Console after authentication, you need to modify the `complete-auth.js` Lambda function to build the AWS Console sign-in URL.

### 4.1 Update complete-auth.js

Add the following helper function to build AWS Console federation URLs:

```javascript
async function buildConsoleUrl(authCode, roleArn, accountId) {
  // Exchange auth code for tokens (implement token exchange)
  const tokens = await exchangeCodeForTokens(authCode);
  
  // Build federation sign-in URL
  const sessionParams = {
    sessionId: tokens.access_token,
    sessionKey: tokens.id_token,
    sessionToken: tokens.refresh_token
  };
  
  const federationUrl = 'https://signin.aws.amazon.com/federation';
  const signinTokenUrl = `${federationUrl}?Action=getSigninToken&SessionDuration=43200&Session=${encodeURIComponent(JSON.stringify(sessionParams))}`;
  
  // Get sign-in token
  const signinTokenResponse = await fetch(signinTokenUrl);
  const signinToken = await signinTokenResponse.json();
  
  // Build console URL
  const consoleUrl = `${federationUrl}?Action=login&Issuer=oidc-provider&Destination=https://console.aws.amazon.com/&SigninToken=${signinToken.SigninToken}`;
  
  return consoleUrl;
}
```

## Step 5: Testing the Integration

### 5.1 Test Flow

1. Navigate to the authorization endpoint:
```
https://YOUR_API_URL/dev/auth?client_id=aws-console&redirect_uri=https://signin.aws.amazon.com/federation&response_type=code&scope=openid+profile+email
```

2. You'll be redirected to the custom login page

3. After login, you'll see the landing page with available applications

4. Click on "AWS Console (Production)"

5. You'll be redirected to the AWS Console with the assumed role

### 5.2 Verify Role Assumption

Once logged in to the AWS Console, verify the assumed role:

```bash
# In the AWS Console top-right corner, you should see:
# <username> @ <account-alias>
# Role: OIDCConsoleReadOnly
```

## Step 6: Adding Multiple AWS Accounts

To add access to multiple AWS accounts:

### 6.1 Repeat Steps 1-2 in Each Account

1. Register the OIDC provider in each AWS account
2. Create IAM roles with appropriate permissions

### 6.2 Register Each Account as Separate Application

```bash
# Dev Account
aws dynamodb put-item \
  --table-name "oidc-provider-${ENV}-applications" \
  --item '{
    "application_id": {"S": "aws-console-dev"},
    "name": {"S": "AWS Console (Development)"},
    "description": {"S": "Development AWS account console access"},
    "icon": {"S": "ðŸ”§"},
    "enabled": {"BOOL": true},
    "client_id": {"S": "aws-console"},
    "redirect_url": {"S": "https://signin.aws.amazon.com/federation"},
    "role_arn": {"S": "arn:aws:iam::111111111111:role/OIDCConsoleDev"},
    "account_id": {"S": "111111111111"},
    "account_name": {"S": "Development"}
  }'

# Staging Account
aws dynamodb put-item \
  --table-name "oidc-provider-${ENV}-applications" \
  --item '{
    "application_id": {"S": "aws-console-staging"},
    "name": {"S": "AWS Console (Staging)"},
    "description": {"S": "Staging AWS account console access"},
    "icon": {"S": "ðŸ§ª"},
    "enabled": {"BOOL": true},
    "client_id": {"S": "aws-console"},
    "redirect_url": {"S": "https://signin.aws.amazon.com/federation"},
    "role_arn": {"S": "arn:aws:iam::222222222222:role/OIDCConsoleStaging"},
    "account_id": {"S": "222222222222"},
    "account_name": {"S": "Staging"}
  }'
```

### 6.3 Grant User Access to Multiple Accounts

```bash
# Grant access to all accounts
aws dynamodb put-item \
  --table-name "oidc-provider-${ENV}-user-applications" \
  --item '{
    "user_id": {"S": "'"$USER_ID"'"},
    "application_id": {"S": "aws-console-dev"},
    "accounts": {"L": [{"S": "Development"}]},
    "created_at": {"S": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}
  }'

aws dynamodb put-item \
  --table-name "oidc-provider-${ENV}-user-applications" \
  --item '{
    "user_id": {"S": "'"$USER_ID"'"},
    "application_id": {"S": "aws-console-staging"},
    "accounts": {"L": [{"S": "Staging"}]},
    "created_at": {"S": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}
  }'
```

## Troubleshooting

### Issue: "Invalid identity token"

**Solution**: Verify that:
- The OIDC provider is correctly registered in IAM
- The audience (client_id) matches in both the provider and the token
- The issuer URL in the token matches the registered provider URL

### Issue: "User is not authorized to assume role"

**Solution**: Check that:
- The trust policy includes the correct OIDC provider ARN
- The audience condition matches your client ID
- The subject (sub) condition allows the user

### Issue: "Cannot find application in landing page"

**Solution**: Verify that:
- The application is registered in the applications table
- The user has a mapping in the user-applications table
- The application is enabled (`enabled: true`)

### Issue: "Redirect URI mismatch"

**Solution**: Ensure:
- The redirect URI in the client registration matches exactly
- For AWS Console federation, use: `https://signin.aws.amazon.com/federation`
- No trailing slashes or query parameters in the registered URI

## Security Best Practices

1. **Use least privilege IAM policies**: Only grant permissions that users need
2. **Implement MFA**: Require MFA for assuming sensitive roles
3. **Set session duration**: Limit session duration in role trust policies
4. **Audit logs**: Enable CloudTrail to log all AssumeRoleWithWebIdentity calls
5. **Rotate secrets**: Regularly rotate OAuth client secrets
6. **Use conditions**: Add IP restrictions or time-based conditions in trust policies

Example trust policy with additional conditions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::123456789012:oidc-provider/abc123.execute-api.us-east-1.amazonaws.com/dev"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "abc123.execute-api.us-east-1.amazonaws.com/dev:aud": "aws-console"
        },
        "IpAddress": {
          "aws:SourceIp": ["203.0.113.0/24"]
        },
        "DateGreaterThan": {
          "aws:CurrentTime": "2024-01-01T00:00:00Z"
        },
        "DateLessThan": {
          "aws:CurrentTime": "2024-12-31T23:59:59Z"
        }
      }
    }
  ]
}
```

## Advanced Configuration

### Session Duration

Configure session duration in the IAM role:

```bash
aws iam update-role \
  --role-name OIDCConsoleReadOnly \
  --max-session-duration 43200  # 12 hours
```

### Custom Login Branding

Customize the login page by modifying `static/login.html`:
- Update logo and colors
- Add organization branding
- Customize messaging

### Audit and Monitoring

Set up CloudWatch alarms for OIDC authentication:

```bash
# Monitor failed authentication attempts
aws logs put-metric-filter \
  --log-group-name /aws/lambda/oidc-provider-dev-auth \
  --filter-name FailedAuthentication \
  --filter-pattern "[timestamp, request_id, level=ERROR, msg=\"*Authentication failed*\"]" \
  --metric-transformations \
    metricName=FailedAuthenticationCount,\
    metricNamespace=OIDC,\
    metricValue=1
```

## References

- [AWS IAM OIDC Identity Providers](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html)
- [AssumeRoleWithWebIdentity](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)
- [AWS Federation Sign-In](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_enable-console-custom-url.html)

## Support

For issues or questions:
- Check the [troubleshooting section](#troubleshooting)
- Review CloudWatch logs for Lambda functions
- Open an issue on GitHub
